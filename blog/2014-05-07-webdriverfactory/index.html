<!doctype html><html class="no-js" lang="ru"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title> И ещё раз о том, как "правильно" запускать браузер</title><link rel="stylesheet" type="text/css" href="https://webdriver.ru/assets/css/styles_feeling_responsive.css" /> <script src="https://webdriver.ru/assets/js/modernizr.min.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script> <script> WebFont.load({ google: { families: [ 'Source Code Pro', 'Arimo::cyrillic', 'Philosopher::cyrillic' ] } }); </script> <noscript><link rel="preload" href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Arimo|Philosopher' rel='stylesheet' type='text/css' /> </noscript><meta name="description" content="Примерно раз в год я пишу статью про то, «как правильно запускать браузер» :) Но эта, надеюсь, будет последняя в серии. Небольшая предыстория. Давным-давно, в 2010 году на конференции SeleniumCamp я рассказывал про оптимизацию скорости выполнения тестов, и одна из первых рекомендаций была «используйте уже запущенный браузер повторно, не перезапускайте его для каждого теста заново». Потому что запуск браузера — весьма длительная и ресурсоёмкая операция. Чуть позже, уже в 2011 году, я написал первую статью, в которой я изложил «теоретические основы науки о запуске браузеров». Через год после этого появилась вторая статья, в которой описывалась конкретная реализация утилиты, управляющей запущенными браузерами. К ней, естественно, прилагался проект с программным кодом этой утилиты. Ещё через год я наконец выложил усовершенствованный вариант этой утилиты на GitHub, и вот теперь пришло время написать сопроводительную документацию" /><link rel="icon" sizes="32x32" href="https://webdriver.ru/assets/img/favicon-32x32.png" /><link rel="icon" sizes="192x192" href="https://webdriver.ru/assets/img/touch-icon-192x192.png" /><link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://webdriver.ru/assets/img/apple-touch-icon-180x180-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://webdriver.ru/assets/img/apple-touch-icon-152x152-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://webdriver.ru/assets/img/apple-touch-icon-144x144-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://webdriver.ru/assets/img/apple-touch-icon-120x120-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://webdriver.ru/assets/img/apple-touch-icon-114x114-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://webdriver.ru/assets/img/apple-touch-icon-76x76-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://webdriver.ru/assets/img/apple-touch-icon-72x72-precomposed.png" /><link rel="apple-touch-icon-precomposed" href="https://webdriver.ru/assets/img/apple-touch-icon-precomposed.png" /><meta name="msapplication-TileImage" content="https://webdriver.ru/assets/img/msapplication_tileimage.png" /><meta name="msapplication-TileColor" content="#fabb00" /><meta property="og:locale" content="en_EN" /><meta property="og:title" content="И ещё раз о том, как "правильно" запускать браузер" /><meta property="og:description" content="Примерно раз в год я пишу статью про то, «как правильно запускать браузер» :) Но эта, надеюсь, будет последняя в серии. Небольшая предыстория. Давным-давно, в 2010 году на конференции SeleniumCamp я рассказывал про оптимизацию скорости выполнения тестов, и одна из первых рекомендаций была «используйте уже запущенный браузер повторно, не перезапускайте его для каждого теста заново». Потому что запуск браузера — весьма длительная и ресурсоёмкая операция. Чуть позже, уже в 2011 году, я написал первую статью, в которой я изложил «теоретические основы науки о запуске браузеров». Через год после этого появилась вторая статья, в которой описывалась конкретная реализация утилиты, управляющей запущенными браузерами. К ней, естественно, прилагался проект с программным кодом этой утилиты. Ещё через год я наконец выложил усовершенствованный вариант этой утилиты на GitHub, и вот теперь пришло время написать сопроводительную документацию"/><meta property="og:url" content="https://webdriver.ru//blog/2014-05-07-webdriverfactory/" /><meta property="og:site_name" content="Selenium WebDriver: автоматизация веб-приложений" /><link type="text/plain" rel="author" href="https://webdriver.ru/humans.txt" /><body id="top-of-page" class="post"><div id="page"><div id="masthead-no-image-header"><div class="row"><div class="small-12 columns"> <a id="logo" href="https://webdriver.ru" title="Selenium WebDriver: автоматизация веб-приложений"> <img src="https://webdriver.ru/assets/img/logo.png" alt="Selenium WebDriver: автоматизация веб-приложений – "><h1>Selenium WebDriver</h1><h2>автоматизация веб-приложений</h2></a></div></div></div><div id="navigation" class="sticky"><nav class="top-bar" role="navigation" data-topbar><ul class="title-area"><li class="name"><h1 class="show-for-small-only"><a href="https://webdriver.ru" class="icon-tree"> Selenium WebDriver</a></h1><li class="toggle-topbar menu-icon"><a href="#"><span>Меню</span></a></ul><section class="top-bar-section"><ul class="right"><li class="divider"><li><a href="https://webdriver.ru/search/">Поиск</a></ul><ul class="left"><li link-url="/" page-url="/blog/2014-05-07-webdriverfactory/" ><a href="https://webdriver.ru/">Старт</a><li class="divider"><li link-url="/news/" page-url="/blog/2014-05-07-webdriverfactory/" ><a href="https://webdriver.ru/news/">Новости</a><li class="divider"><li link-url="/blog/" page-url="/blog/2014-05-07-webdriverfactory/" class="active"><a href="https://webdriver.ru/blog/">Блог</a><li class="divider"><li link-url="/trainings/" page-url="/blog/2014-05-07-webdriverfactory/" ><a href="https://webdriver.ru/trainings/">Обучение</a><li class="divider"><li link-url="http://software-testing.ru/forum/index.php?/forum/129-selenium-functional-testing/" page-url="/blog/2014-05-07-webdriverfactory/" ><a href="http://software-testing.ru/forum/index.php?/forum/129-selenium-functional-testing/" target="_blank">Форум</a><li class="divider"></ul></section></nav><div id="breadcrumb"><div class="row"><nav class="breadcrumbs bootstrap hidden-sm-down"> <a property="item" typeof="WebPage" href="/index.html"> <span class="icon-home" property="name"></span><meta property="position" content="1" /> </a> <a property="item" typeof="WebPage" href="/blog/index.html"> <span property="name">Блог</span><meta property="position" content="2" /> </a> <span property="name">И ещё раз о том, как "правильно" запускать браузер</span><meta property="position" content="3" /></nav></div></div></div><div class="row t30"><div class="medium-8 columns"><article itemscope itemtype="http://schema.org/Article"><header> <span itemprop="name"><div class="date"><time class="icon-calendar pr20" datetime="2014-05-07" itemprop="datePublished"> 7 мая 2014 </time></div><h1>И ещё раз о том, как "правильно" запускать браузер</h1></span></header><span itemprop="articleSection"><p>Примерно раз в год я пишу статью про то, «как правильно запускать браузер» :)<p>Но эта, надеюсь, будет последняя в серии.<p>Небольшая предыстория. Давным-давно, в 2010 году на конференции SeleniumCamp я рассказывал про оптимизацию скорости выполнения тестов, и одна из первых рекомендаций была «используйте уже запущенный браузер повторно, не перезапускайте его для каждого теста заново». Потому что запуск браузера — весьма длительная и ресурсоёмкая операция. Чуть позже, уже в 2011 году, я написал <a href="/blog/65-how-to-start-browser-in-theory.html">первую статью</a>, в которой я изложил «теоретические основы науки о запуске браузеров». Через год после этого появилась <a href="/blog/66-how-to-start-browser-with-driver-factory.html">вторая статья</a>, в которой описывалась конкретная реализация утилиты, управляющей запущенными браузерами. К ней, естественно, прилагался проект с программным кодом этой утилиты. Ещё через год я наконец выложил усовершенствованный вариант этой утилиты на <a href="https://github.com/barancev/webdriver-factory/">GitHub</a>, и вот теперь пришло время написать сопроводительную документацию.<h2 id="что-это-такое">Что это такое?</h2><p>WebDriverFactory — это библиотека, которая помогает управлять запущенными экземплярами WebDriver (ну и браузерами тоже, поскольку каждому экземпляру драйвера соответствует свой экземпляр браузера).<p>Цель: предоставить пользователям инструмент, который умеет<ul><li>автоматически создавать драйвер (и запускать браузер) по требованию в момент первого использования,<li>повторно использовать уже созданные драйверы, если есть такая возможность,<li>автоматически останавливать старый и запускать новый, когда понадобился драйвер с другими характеристиками,<li>автоматически запускать нового драйвера, если предыдущий экземпляр недоступен,<li>останавливать все запущенные драйверы одной командой.</ul><p>По сравнению с тем, что было описано в предыдущей статье, я отказался от следующих «сомнительных фич»<ul><li>автоматический перезапуск драйвера после заданного количества использований — раньше это было актуально, когда у браузера Firefox наблюдались серьёзные утечки памяти, сейчас эта «фича» уже практически невостребована, а если очень нужно — её можно реализовать при помощи несложного счётчика на уровне конфигурацинных методов тестового набора (@Before)<li>автоматический останов всех драйверов при завершении работы виртуальной машины Java — эта фича осталась, но её не рекомендуется использовать, потому что с некоторыми браузерами возникают проблемы именно при остановке их из shutdown hook, так что лучше явно в конце выполнять остановку всех драйверов специальной командой.</ul><p>(Вообще говоря, название «фабрика» (Factory) не совсем правильное, потому что эта библиотека реализует шаблон проектирования, который больше похож на <a href="http://sourcemaking.com/design_patterns/object_pool">Object Pool</a>, но я решил оставить сложившееся исторически название, потому что и «пул» тоже является одной из вариаций общей концепции <a href="http://en.wikipedia.org/wiki/Factory_(software_concept)">Factory</a>).<h2 id="как-подключить-библиотеку-к-проекту">Как подключить библиотеку к проекту?</h2><p>Если вы используете Maven — достаточно просто добавить зависимости от фабрики и от самой библиотеки Selenium:<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>ru.stqa.selenium<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>webdriver-factory<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.seleniumhq.selenium<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>selenium-java<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.53.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.seleniumhq.selenium<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>selenium-server<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>2.53.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span></code></pre></figure><p>Номер последней доступной версии смотрите в <a href="http://search.maven.org/#browse%7C-716647851">центральном репозитории Maven</a>.<p>Если вы не используете Maven — тогда оттуда же из центрального репозитория нужно скачать jar-файл <code class="highlighter-rouge">webdriver-factory-2.0.jar</code> (номер версии может быть другим, конечно) и подключить его к вашему проекту так, как вы подключаете другие jar-файлы.<h2 id="как-это-работает">Как это работает?</h2><p>Фабрика имеет два основных режима работы:<ul><li><code class="highlighter-rouge">SINGLETON</code> — в каждый момент времени может существовать не более одного экземпляра WebDriver, управляемого фабрикой<li><code class="highlighter-rouge">THREADLOCAL_SINGLETON</code> — в каждый момент времени в каждом потоке может существовать не более одного экземпляра WebDriver, управляемого фабрикой</ul><p>По умолчанию используется режим работы THREADLOCAL_SINGLETON. Режимы работы можно переключать, если нет ни одного запущенного драйвера:<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="n">WebDriverFactory</span><span class="o">.</span><span class="na">setMode</span><span class="o">(</span><span class="n">WebDriverFactoryMode</span><span class="o">.</span><span class="na">SINGLETON</span><span class="o">);</span></code></pre></figure><h3 id="режим-работы-singleton">Режим работы <code class="highlighter-rouge">SINGLETON</code></h3><p>Давайте рассмотрим, как работает вот такой сценарий:<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="c1">// 1. первый запрос на получение драйвера</span>
<span class="n">Capabilities</span> <span class="n">firefox</span> <span class="o">=</span> <span class="n">DesiredCapabilities</span><span class="o">.</span><span class="na">firefox</span><span class="o">();</span>
<span class="n">WebDriver</span> <span class="n">driver</span> <span class="o">=</span> <span class="n">WebDriverFactory</span><span class="o">.</span><span class="na">getDriver</span><span class="o">(</span><span class="n">firefox</span><span class="o">);</span>
<span class="c1">// 2. второй запрос на получение драйвера, с теми же характеристиками</span>
<span class="n">driver</span> <span class="o">=</span> <span class="n">WebDriverFactory</span><span class="o">.</span><span class="na">getDriver</span><span class="o">(</span><span class="n">firefox</span><span class="o">);</span>
<span class="c1">// 3. третий запрос на получение драйвера, с другими характеристиками</span>
<span class="n">Capabilities</span> <span class="n">chrome</span> <span class="o">=</span> <span class="n">DesiredCapabilities</span><span class="o">.</span><span class="na">chrome</span><span class="o">();</span>
<span class="n">driver</span> <span class="o">=</span> <span class="n">WebDriverFactory</span><span class="o">.</span><span class="na">getDriver</span><span class="o">(</span><span class="n">chrome</span><span class="o">);</span>
<span class="c1">// 4. остановка драйвера</span>
<span class="n">WebDriverFactory</span><span class="o">.</span><span class="na">dismiss</span><span class="o">(</span><span class="n">driver</span><span class="o">);</span></code></pre></figure><ul><li>При первом запросе запускается новый драйвер (и новый браузер).<li>При втором запросе, поскольку требуется драйвер с теми же характеристиками, возвращается ранее запущенный драйвер.<li>При третьем запросе, поскольку требуется драйвер с другими характеристиками, предыдущий драйвер автоматически останавливается, и вместо него запускается новый, с запрашиваемыми характеристиками.<li>Метод dismiss останавливает единственный существующий драйвер.</ul><h3 id="режим-работы-threadlocal_singleton">Режим работы <code class="highlighter-rouge">THREADLOCAL_SINGLETON</code></h3><p>Этот режим работы необходим при параллельном выполнении тестов в нескольких потоках, чтобы избежать конфликтов. Он работает аналогично предыдущему, но только для каждого потока проверки выполняются независимо.<p>То есть если весь вышеуказанный код выполняется в одном и том же потоке — всё будет работать точно так же, как описано в предыдущем разделе: сначала запускается новый драйвер, потом он повторно используется, потом он останавливается и вместо него запускается драйвер с другими характеристиками, и наконец этот последний драйвер останавливается.<p>Но если тесты работают в нескольких параллельно выполняющихся потоках, то второй запрос драйвера с теми же характеристиками может случиться в другом потоке, и тогда будет создан новый драйвер, несмотря на то, что драйвер с нужными характеристиками уже есть. У каждого потока свой драйвер, использовать драйвер другого потока фабрика не позволит.<p>Аналогично, если потребовался драйвер с другими характеристиками — он будет запущен, но остановлен при этом может быть только драйвер, который ранее был запущен в том же самом потоке. Драйверы, принадлежащие другим потокам, останутся нетронутыми.<h2 id="чем-ещё-полезна-фабрика">Чем ещё полезна фабрика?</h2><p>Есть у фабрики ещё пара полезных функций, помимо хранения драйверов для повторного использования и их автоматического перезапуска.<p>Перед тем, как вернуть клиенту существующий драйвер, фабрика проверяет, что он функционирует нормально — вызывает метод <code class="highlighter-rouge">getCurrentUrl()</code>. Если этот метод отработает успешно — фабрика вернёт клиенту этот ранее запущенный драйвер. Но если возникают проблемы, драйвер считается «испорченным», в этом случае фабрика запустит новый и вернёт его. В любом случае, клиент получит старый или новый, но работающий драйвер, удовлетворяющий заданным характеристикам.<p>Кроме того, поскольку фабрика хранит все запущенные драйверы, она позволяет в конце остановить все оставшиеся активные драйверы одной командой <code class="highlighter-rouge">dismissAll()</code>:<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@AfterSuite</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">stopAllDrivers</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">WebDriverFactory</span><span class="o">.</span><span class="na">dismissAll</span><span class="o">();</span>
<span class="o">}</span></code></pre></figure><p>В проекте на GitHub можно посмотреть <a href="https://github.com/barancev/webdriver-factory-samples/tree/master/src/test/java/ru/stqa/selenium/factory/samples">примеры использования фабрики</a> с тестовыми фреймворками JUnit и TestNG.<h2 id="будет-ли-продолжение">Будет ли продолжение?</h2><p>Возможно, в будущем появятся новые режимы работы фабрики, накладывающие меньше ограничений и ориентированные на удалённый запуск с использованием Selenium Grid. Но с концептуальной точки зрения я считаю для себя тему запуска браузеров закрытой. Впрочем, я буду рад ошибиться. Если есть какие-то идеи развития — <a href="https://github.com/barancev/webdriver-factory/">присылайте пулл-реквесты</a>! </span><div id="page-meta" class="t30"><p> <time class="icon-calendar pr20" datetime="2014-05-07" itemprop="datePublished"> 7 мая 2014 </time> <span class="icon-archive pr20">&nbsp;<a href="https://webdriver.ru/blog/">БЛОГ</a></span> <br /> <span class="pr20"></span><ul class="pager"><li><a href="https://webdriver.ru/blog/2014-01-22-selenium-i-browsermobproxy-vmeste-veselee/">&larr; Selenium и BrowserMobProxy: вместе веселее!</a><li>&nbsp;|&nbsp;<li><a href="https://webdriver.ru/blog/2014-05-28-junit-testng-maven-ant-gradle/">Интеграция JUnit и TestNG со сборщиками Maven, Ant и Gradle &rarr;</a></ul></div></article></div><div class="medium-4 columns"><aside><div class="panel radius"><h3>Новые публикации</h3><ul class="side-nav"><li><a href="https://webdriver.ru/news/2019-11-25-seleniumconf-london/">Опубликованы материалы конференции SeleniumConf London 2019</a><li><a href="https://webdriver.ru/news/2019-11-18-selenium-dev/">Запущен новый сайт selenium.dev</a><li><a href="https://webdriver.ru/news/2018-07-10-selenium-314/">Вышел релиз Selenium 3.14</a><li><a href="https://webdriver.ru/news/2018-07-10-selenium-313/">Вышел релиз Selenium 3.13</a><li><a href="https://webdriver.ru/news/2018-06-25-selenium-312/">Вышел релиз Selenium 3.12</a></ul></div><div class="panel radius"><h3>Ближайшие тренинги</h3><ul class="side-nav"><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/242-selenium-webdriver"><time class="icon-calendar date"> 18 июня 2021</time><br>Selenium WebDriver: полное руководство</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/226-csharp-for-testers"><time class="icon-calendar date"> 25 июня 2021</time><br>Программирование на C# для тестировщиков</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/19-performance-testing-jmeter"><time class="icon-calendar date"> 2 июля 2021</time><br>Тестирование производительности: JMeter 5</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/185-selenium"><time class="icon-calendar date"> 9 июля 2021</time><br>Selenium IDE 3: стартовый уровень</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/1-java-for-testers"><time class="icon-calendar date"> 9 июля 2021</time><br>Программирование на Java для тестировщиков</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/46-test-design"><time class="icon-calendar date"> 16 июля 2021</time><br>Практикум по тест-дизайну 2.0</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/189-web"><time class="icon-calendar date"> 16 июля 2021</time><br>Тестирование веб-приложений 2.0</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/234-functional-test-automation"><time class="icon-calendar date"> 23 июля 2021</time><br>Автоматизация функционального тестирования</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/233-python"><time class="icon-calendar date"> 23 июля 2021</time><br>Программирование на Python для тестировщиков</a></span></ul></div></aside></div></div><footer id="footer-content" class="bg-grau"><div id="footer"><div class="row"><div class="medium-6 large-5 columns"><h5 class="shadow-black">О нас</h5><ul class="no-bullet shadow-black"><li><a href="https://webdriver.ru/info/">Пишем про Selenium на русском языке</a></ul></div><div class="small-6 medium-3 large-3 large-offset-1 columns"><h5 class="shadow-black">RSS/Atom</h5><ul class="no-bullet shadow-black"><li > <a href="" title=""></a><li > <a href="/feed.xml" title="Subscribe to RSS Feed">RSS</a><li > <a href="/atom.xml" title="Subscribe to Atom Feed">Atom</a></ul></div><div class="small-6 medium-3 large-3 columns"><h5 class="shadow-black">Благодарности</h5><ul class="no-bullet shadow-black"><li > <a href="" title=""></a><li class="services-newsletter" > <a href="https://jekyllrb.com/" target="_blank" title="Built with Jekyll">Built with Jekyll</a><li class="services-newsletter" > <a href="https://github.com/Phlow/feeling-responsive" target="_blank" title="Design by Phlow">Design by Phlow</a><li class="services-newsletter" > <a href="http://foundation.zurb.com/" target="_blank" title="Built on Foundation">Built on Foundation</a></ul></div></div></div><div id="subfooter"><nav class="row"><section id="subfooter-left" class="b30 small-12 medium-6 columns credits"></section><section id="subfooter-right" class="small-12 medium-6 columns social-icons"><ul class="inline-list"></ul></section></nav></div></footer><script src="https://webdriver.ru/assets/js/javascript.min.js"></script></div>
