<!doctype html><html class="no-js" lang="ru"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title> Как правильно запускать браузер, часть 2</title><link rel="stylesheet" type="text/css" href="https://webdriver.ru/assets/css/styles_feeling_responsive.css" /> <script src="https://webdriver.ru/assets/js/modernizr.min.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script> <script> WebFont.load({ google: { families: [ 'Source Code Pro', 'Arimo::cyrillic', 'Philosopher::cyrillic' ] } }); </script> <noscript><link rel="preload" href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Arimo|Philosopher' rel='stylesheet' type='text/css' /> </noscript><meta name="description" content="Чуть более года тому назад я написал статью, в которой рассказал, какими свойствами должен обладать &quot;правильный&quot; механизм запуска браузера. Эта статья должна была иметь продолжение, в котором я планировал описать реализацию такого механизма. Но желания не всегда совпадают с возможностями, и продолжение статьи тогда так и не появилось. Но некоторое время тому назад мы организовали рассылку &quot;Сотня полезных советов про Selenium&quot;, в рамках этой рассылки среди прочих была написана и заметка про то, как правильно запускать браузер, и мы решили опубликовать её как самостоятельную статью." /><link rel="icon" sizes="32x32" href="https://webdriver.ru/assets/img/favicon-32x32.png" /><link rel="icon" sizes="192x192" href="https://webdriver.ru/assets/img/touch-icon-192x192.png" /><link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://webdriver.ru/assets/img/apple-touch-icon-180x180-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://webdriver.ru/assets/img/apple-touch-icon-152x152-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://webdriver.ru/assets/img/apple-touch-icon-144x144-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://webdriver.ru/assets/img/apple-touch-icon-120x120-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://webdriver.ru/assets/img/apple-touch-icon-114x114-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://webdriver.ru/assets/img/apple-touch-icon-76x76-precomposed.png" /><link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://webdriver.ru/assets/img/apple-touch-icon-72x72-precomposed.png" /><link rel="apple-touch-icon-precomposed" href="https://webdriver.ru/assets/img/apple-touch-icon-precomposed.png" /><meta name="msapplication-TileImage" content="https://webdriver.ru/assets/img/msapplication_tileimage.png" /><meta name="msapplication-TileColor" content="#fabb00" /><meta property="og:locale" content="en_EN" /><meta property="og:title" content="Как правильно запускать браузер, часть 2" /><meta property="og:description" content="Чуть более года тому назад я написал статью, в которой рассказал, какими свойствами должен обладать &quot;правильный&quot; механизм запуска браузера. Эта статья должна была иметь продолжение, в котором я планировал описать реализацию такого механизма. Но желания не всегда совпадают с возможностями, и продолжение статьи тогда так и не появилось. Но некоторое время тому назад мы организовали рассылку &quot;Сотня полезных советов про Selenium&quot;, в рамках этой рассылки среди прочих была написана и заметка про то, как правильно запускать браузер, и мы решили опубликовать её как самостоятельную статью."/><meta property="og:url" content="https://webdriver.ru//blog/2012-10-31-how-to-start-browser-with-driver-factory/" /><meta property="og:site_name" content="Selenium WebDriver: автоматизация веб-приложений" /><link type="text/plain" rel="author" href="https://webdriver.ru/humans.txt" /><body id="top-of-page" class="post"><div id="page"><div id="masthead-no-image-header"><div class="row"><div class="small-12 columns"> <a id="logo" href="https://webdriver.ru" title="Selenium WebDriver: автоматизация веб-приложений"> <img src="https://webdriver.ru/assets/img/logo.png" alt="Selenium WebDriver: автоматизация веб-приложений – "><h1>Selenium WebDriver</h1><h2>автоматизация веб-приложений</h2></a></div></div></div><div id="navigation" class="sticky"><nav class="top-bar" role="navigation" data-topbar><ul class="title-area"><li class="name"><h1 class="show-for-small-only"><a href="https://webdriver.ru" class="icon-tree"> Selenium WebDriver</a></h1><li class="toggle-topbar menu-icon"><a href="#"><span>Меню</span></a></ul><section class="top-bar-section"><ul class="right"><li class="divider"><li><a href="https://webdriver.ru/search/">Поиск</a></ul><ul class="left"><li link-url="/" page-url="/blog/2012-10-31-how-to-start-browser-with-driver-factory/" ><a href="https://webdriver.ru/">Старт</a><li class="divider"><li link-url="/news/" page-url="/blog/2012-10-31-how-to-start-browser-with-driver-factory/" ><a href="https://webdriver.ru/news/">Новости</a><li class="divider"><li link-url="/blog/" page-url="/blog/2012-10-31-how-to-start-browser-with-driver-factory/" class="active"><a href="https://webdriver.ru/blog/">Блог</a><li class="divider"><li link-url="/trainings/" page-url="/blog/2012-10-31-how-to-start-browser-with-driver-factory/" ><a href="https://webdriver.ru/trainings/">Обучение</a><li class="divider"><li link-url="http://software-testing.ru/forum/index.php?/forum/129-selenium-functional-testing/" page-url="/blog/2012-10-31-how-to-start-browser-with-driver-factory/" ><a href="http://software-testing.ru/forum/index.php?/forum/129-selenium-functional-testing/" target="_blank">Форум</a><li class="divider"></ul></section></nav><div id="breadcrumb"><div class="row"><nav class="breadcrumbs bootstrap hidden-sm-down"> <a property="item" typeof="WebPage" href="/index.html"> <span class="icon-home" property="name"></span><meta property="position" content="1" /> </a> <a property="item" typeof="WebPage" href="/blog/index.html"> <span property="name">Блог</span><meta property="position" content="2" /> </a> <span property="name">Как правильно запускать браузер, часть 2</span><meta property="position" content="3" /></nav></div></div></div><div class="row t30"><div class="medium-8 columns"><article itemscope itemtype="http://schema.org/Article"><header> <span itemprop="name"><div class="date"><time class="icon-calendar pr20" datetime="2012-10-31" itemprop="datePublished"> 31 октября 2012 </time></div><h1>Как правильно запускать браузер, часть 2</h1></span></header><span itemprop="articleSection"><p>Чуть более года тому назад я <a href="/articles/65-how-to-start-browser-in-theory.html">написал статью</a>, в которой рассказал, какими свойствами должен обладать “правильный” механизм запуска браузера. Эта статья должна была иметь продолжение, в котором я планировал описать реализацию такого механизма. Но желания не всегда совпадают с возможностями, и продолжение статьи тогда так и не появилось. Но некоторое время тому назад мы организовали рассылку “Сотня полезных советов про Selenium”, в рамках этой рассылки среди прочих была написана и заметка про то, как правильно запускать браузер, и мы решили опубликовать её как самостоятельную статью.<p>Ниже описана реализация универсального механизма запуска браузера, обладающего следующими возможностями:<ul><li>запуск браузера “по требованию”, в момент первого использования,<li>повторное использование уже запущенного браузера,<li>автоматический перезапуск браузера, если требуется браузер с другими характеристиками,<li>автоматический запуск нового браузера, если предыдущий экземпляр недоступен,<li>автоматический перезапуск браузера после заданного количества использований,<li>автоматический останов браузера в конце, при завершении работы виртуальной машины Java.</ul><p>К статье <a href="http://software-testing.ru/files/selenium-factory.zip">прилагается готовый проект</a>, который содержит класс <code class="highlighter-rouge">WebDriverFactory</code>, реализующий этот механизм запуска браузера, а также ряд примеров его использования.<div class="alert-box info radius "><p>Со временем из этого примера выросла вполне самостоятельная и зрелая библиотека, читайте про неё в <a href="/blog/2014-05-07-webdriverfactory/">продолжении этой статьи</a></div><p>Сначала я вкратце опишу, как это работает (подробности смотрите в коде :)), а потом прокомментирую примеры.<p>Глядя на название класса <code class="highlighter-rouge">WebDriverFactory</code> вы можете предположить, что он реализует шаблон проектирования Object Factory. Это не совсем так, реализация не соответствует в точности ни одному из шаблонов, описанных в знаменитой <a href="http://ru.wikipedia.org/wiki/Design_Patterns">книге “банды четырёх” Design Patterns</a>.<p>Реализация класса <code class="highlighter-rouge">WebDriverFactory</code> представляет собой нечто среднее между фабрикой и синглетоном. Может быть это даже больше похоже на “пул объектов”, но маленький такой, одноместный пул. Но я буду далее употреблять слово “фабрика”, потому что оно красивое, и потому что все эти шаблоны проектирования так или иначе всё равно являются реализациями <a href="http://en.wikipedia.org/wiki/Factory_(software_concept)">единой идеи</a>.<p>Класс <code class="highlighter-rouge">WebDriverFactory</code> содержит метод getDriver, который по запросу создаёт экземпляр типа <code class="highlighter-rouge">WebDriver</code>, соответствующий переданному параметру capabilities. Ссылка на созданный объект сохраняется внутри фабрики, и при следующем обращении, если затребован драйвер с теми же самыми capabilities, используется ранее созданный экземпляр. Но если пришёл запрос на драйвер с другими capabilities, тогда предыдущий браузер останавливается, драйвер уничтожается и создаётся новый, с запрошенными параметрами.<p>Кроме того, <code class="highlighter-rouge">WebDriverFactory</code> автоматически останавливает браузер при завершении работы Java-машины.<p>Таким образом, вам вообще больше нет необходимости заботиться об остановке браузера, это происходит само либо тогда, когда вам понадобился новый браузер, либо в конце выполнения тестов.<p>Но это ещё не все возможности <code class="highlighter-rouge">WebDriverFactory</code>.<p>Если пришёл запрос, в ответ на который нужно вернуть уже имеющийся драйвер, фабрика проверяет, что браузер доступен – выполняет метод <code class="highlighter-rouge">getCurrentUrl</code>, и если он отработал без ошибок, считается, что с браузером всё в порядке. Если же браузер недоступен (завершился аварийно, или был закрыт вручную, или случайно был закрыт предыдущим тестом), создаётся новый драйвер, который запускает новый браузер.<p>И последняя возможность, весьма актуальная, если вы запускаете тесты для сложных приложений в браузере Firefox – периодический перезапуск браузера. Ни для кого не секрет, что Firefox “теряет память”, то есть в процессе работы занимаемая процессом память увеличивается, браузер работает всё медленнее и медленнее, а при достижении некоторого предела может даже упасть. Конечно, можно было бы как-то проверять объём занимаемой памяти, но <code class="highlighter-rouge">WebDriverFactory</code> устроен проще – он перезапускает браузер после заданного количества “использований”, то есть обращений к методу getDriver. Ну а частоту перезапуска вы можете подобрать сами экспериментальным путём.<p>Всё это достаточно хорошо видно, если посмотреть на код метода getDriver:<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">static</span> <span class="n">WebDriver</span> <span class="nf">getDriver</span><span class="o">(</span><span class="n">String</span> <span class="n">hub</span><span class="o">,</span> <span class="n">Capabilities</span> <span class="n">capabilities</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">count</span><span class="o">++;</span>
    <span class="c1">// 1. WebDriver instance is not created yet</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">driver</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">newWebDriver</span><span class="o">(</span><span class="n">hub</span><span class="o">,</span> <span class="n">capabilities</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 2. Different flavour of WebDriver is required</span>
    <span class="n">String</span> <span class="n">newKey</span> <span class="o">=</span> <span class="n">capabilities</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">hub</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">newKey</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">dismissDriver</span><span class="o">();</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">newKey</span><span class="o">;</span>
      <span class="k">return</span> <span class="nf">newWebDriver</span><span class="o">(</span><span class="n">hub</span><span class="o">,</span> <span class="n">capabilities</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 3. Browser is dead</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">driver</span><span class="o">.</span><span class="na">getCurrentUrl</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">t</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
      <span class="k">return</span> <span class="nf">newWebDriver</span><span class="o">(</span><span class="n">hub</span><span class="o">,</span> <span class="n">capabilities</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 4. It's time to restart</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">restartFrequency</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">dismissDriver</span><span class="o">();</span>
      <span class="k">return</span> <span class="nf">newWebDriver</span><span class="o">(</span><span class="n">hub</span><span class="o">,</span> <span class="n">capabilities</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">// 5. Just use existing WebDriver instance</span>
    <span class="k">return</span> <span class="n">driver</span><span class="o">;</span>
  <span class="o">}</span></code></pre></figure><p>А теперь краткое пояснение к примерам.<p><strong>TestNgWebDriverSample</strong> показывает типовой способ использования фабрики с фреймворком TestNG. Инициализация браузера, то есть вызов <code class="highlighter-rouge">getDriver</code> в фабрике, выполняется в <code class="highlighter-rouge">@BeforeMethod</code>, а остановка браузера – в <code class="highlighter-rouge">@AfterSuite</code>. TestNG представляет достаточно богатые возможности управления инициализацией, есть из чего выбирать – можно выполнить некоторый код перед каждым тестовым методом, перед всеми методами класса, перед группой методов, помеченных некоторым тегом, перед тестовым набором (то есть фактически один раз в самом начале выполнения тестов). То же самое относится и к завершающему коду. Но выбор здесь сделан неслучайно. Инициализация драйвера выполняется в <code class="highlighter-rouge">@BeforeMethod</code>, чтобы фабрика перед каждым тестовым методом проверяла, доступен ли браузер, и при необходимости перезапускала его, а также чтобы увеличивался счётчик количества использований и происходил периодический перезапуск браузера. А остановка выполняется в самом конце, в <code class="highlighter-rouge">@AfterSuite</code>, да и та не нужна, можно смело удалить её, потому что фабрика сама остановит браузер.<p><strong>JUnitWebDriverSample</strong> представляет собой пример использования фабрики с фреймворком JUnit. Возможности этого фреймворка гораздо беднее, чем у TestNG, фактически можно лишь определить инициализацию, которая будет выполняться перед каждым тестовым методом. Но при использовании фабрики этого достаточно. Код инициализации выполняется перед каждым тестовым методом, и несмотря на это будет использоваться один и тот же драйвер, об этом позаботится фабрика. Код для остановки браузера отсутствует, потому что он не нужен, всё происходит автоматически.<p>Этот пример показывает, что использование фабрики позволяет вам выбрать даже “плохой” фреймворк, который не позволяет гибко управлять кодом инициализации и завершения, и при этом вы всё равно получаете возможность повторного использования браузера и автоматической остановки в конце выполнения тестов. Из этого также следует, что можно переписать фабрику на другой язык программирования и её можно будет использовать практически с любым фреймворком тестирования, сколь бы ни был он беден возможностями.<p><strong>NoInitWebDriverSample</strong> является модификацией предыдущего примера, в нём нет методов инициализации – обращение к фабрике выполняется ровно в том месте, где вам потребовался браузер, то есть в непосредственно в тестовом методе. Опять таки нигде нет кода для остановки браузера, фабрика делает это сама.<p><strong>VariousBrowsersWebDriverSample</strong> демонстрирует автоматический перезапуск браузера, когда затребован браузер другого типа.<p><strong>RestartingWebDriverSample</strong> показывает, как настроить фабрику для периодического перезапуска браузера. В примере содержится три тестовых метода, а частота перезапуска указана равной двум. В результате после второго теста браузер будет остановлен, а третий тест будет выполняться в новом экземпляре браузера.<p>Ну и ещё раз ссылка на <a href="http://software-testing.ru/files/selenium-factory.zip">проект, содержащий класс WebDriverFactory и примеры его использования</a> </span><div id="page-meta" class="t30"><p> <time class="icon-calendar pr20" datetime="2012-10-31" itemprop="datePublished"> 31 октября 2012 </time> <span class="icon-archive pr20">&nbsp;<a href="https://webdriver.ru/blog/">БЛОГ</a></span> <br /> <span class="pr20"></span><ul class="pager"><li><a href="https://webdriver.ru/blog/2012-09-26-what-is-webdriver/">&larr; Что такое Selenium WebDriver?</a><li>&nbsp;|&nbsp;<li><a href="https://webdriver.ru/blog/2012-11-28-protokolirovanie-v-selenium/">Протоколирование в Selenium &rarr;</a></ul></div></article></div><div class="medium-4 columns"><aside><div class="panel radius"><h3>Новые публикации</h3><ul class="side-nav"><li><a href="https://webdriver.ru/news/2019-11-25-seleniumconf-london/">Опубликованы материалы конференции SeleniumConf London 2019</a><li><a href="https://webdriver.ru/news/2019-11-18-selenium-dev/">Запущен новый сайт selenium.dev</a><li><a href="https://webdriver.ru/news/2018-07-10-selenium-314/">Вышел релиз Selenium 3.14</a><li><a href="https://webdriver.ru/news/2018-07-10-selenium-313/">Вышел релиз Selenium 3.13</a><li><a href="https://webdriver.ru/news/2018-06-25-selenium-312/">Вышел релиз Selenium 3.12</a></ul></div><div class="panel radius"><h3>Ближайшие тренинги</h3><ul class="side-nav"><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/242-selenium-webdriver"><time class="icon-calendar date"> 18 июня 2021</time><br>Selenium WebDriver: полное руководство</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/226-csharp-for-testers"><time class="icon-calendar date"> 25 июня 2021</time><br>Программирование на C# для тестировщиков</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/19-performance-testing-jmeter"><time class="icon-calendar date"> 2 июля 2021</time><br>Тестирование производительности: JMeter 5</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/185-selenium"><time class="icon-calendar date"> 9 июля 2021</time><br>Selenium IDE 3: стартовый уровень</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/1-java-for-testers"><time class="icon-calendar date"> 9 июля 2021</time><br>Программирование на Java для тестировщиков</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/46-test-design"><time class="icon-calendar date"> 16 июля 2021</time><br>Практикум по тест-дизайну 2.0</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/189-web"><time class="icon-calendar date"> 16 июля 2021</time><br>Тестирование веб-приложений 2.0</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/234-functional-test-automation"><time class="icon-calendar date"> 23 июля 2021</time><br>Автоматизация функционального тестирования</a></span><li> <span class="course-title"><a href="http://software-testing.ru/edu/3-online/233-python"><time class="icon-calendar date"> 23 июля 2021</time><br>Программирование на Python для тестировщиков</a></span></ul></div></aside></div></div><footer id="footer-content" class="bg-grau"><div id="footer"><div class="row"><div class="medium-6 large-5 columns"><h5 class="shadow-black">О нас</h5><ul class="no-bullet shadow-black"><li><a href="https://webdriver.ru/info/">Пишем про Selenium на русском языке</a></ul></div><div class="small-6 medium-3 large-3 large-offset-1 columns"><h5 class="shadow-black">RSS/Atom</h5><ul class="no-bullet shadow-black"><li > <a href="" title=""></a><li > <a href="/feed.xml" title="Subscribe to RSS Feed">RSS</a><li > <a href="/atom.xml" title="Subscribe to Atom Feed">Atom</a></ul></div><div class="small-6 medium-3 large-3 columns"><h5 class="shadow-black">Благодарности</h5><ul class="no-bullet shadow-black"><li > <a href="" title=""></a><li class="services-newsletter" > <a href="https://jekyllrb.com/" target="_blank" title="Built with Jekyll">Built with Jekyll</a><li class="services-newsletter" > <a href="https://github.com/Phlow/feeling-responsive" target="_blank" title="Design by Phlow">Design by Phlow</a><li class="services-newsletter" > <a href="http://foundation.zurb.com/" target="_blank" title="Built on Foundation">Built on Foundation</a></ul></div></div></div><div id="subfooter"><nav class="row"><section id="subfooter-left" class="b30 small-12 medium-6 columns credits"></section><section id="subfooter-right" class="small-12 medium-6 columns social-icons"><ul class="inline-list"></ul></section></nav></div></footer><script src="https://webdriver.ru/assets/js/javascript.min.js"></script></div>
